<!DOCTYPE html>
<html>
<head>
    <title>User Dashboard</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 230px;
            background: linear-gradient(180deg, #0f172a, #1e293b);
            color: white;
            padding: 20px;
        }

        .sidebar h2 {
            margin-bottom: 30px;
        }

        .sidebar button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #334155;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: 0.3s;
        }

        .sidebar button:hover {
            background-color: #475569;
        }

        /* Main Area */
        .main {
            flex: 1;
            padding: 30px;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            overflow-y: auto;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button.action {
            background-color: #059669;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        button.action:hover {
            background-color: #047857;
        }

        .status {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 5px;
            display: inline-block;
        }

        .Pending {
            background-color: #fef3c7;
            color: #b45309;
        }

        .Resolved {
            background-color: #dcfce7;
            color: #166534;
        }

        .InProgress {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .vote {
            margin-top: 10px;
            font-weight: bold;
            cursor: pointer;
            color: #065f46;
        }
    </style>
</head>

<body>

<div class="sidebar">
    <h2>
        User Panel
        <span id="notifBadge"
        onclick="openNotifications()"
        style="
            background:#dc2626;
            color:white;
            border-radius:20px;
            padding:4px 10px;
            font-size:12px;
            display:none;
            margin-left:8px;
            cursor:pointer;">
    </span>
    </h2>
    <button onclick="showDashboard()">Dashboard</button>
    <button onclick="viewSchedules()">View Schedules</button>
    <button onclick="viewAllComplaints()">All Complaints</button>
    <button onclick="registerComplaint()">Register Complaint</button>
    <button onclick="viewMyComplaints()">My Complaints</button>
    <button onclick="logout()">Logout</button>
</div>

<div class="main">
    <div id="content" class="card">
        <h2>Welcome ðŸ‘‹</h2>
        <p>Help improve campus facilities.</p>
    </div>
</div>

<script>

// ================= Dashboard =================
function showDashboard() {
    document.getElementById("content").innerHTML = `
        <h2>Welcome ðŸ‘‹</h2>
        <p>You can view schedules, register complaints, and track progress here.</p>
    `;
}

// ================= View Schedules =================
async function viewSchedules() {
    const token = localStorage.getItem("token");

    const res = await fetch("http://localhost:5000/api/schedules", {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();

    let content = "<h2>Cleaning Schedules</h2>";

    data.schedules.forEach(s => {
        content += `
            <div class="card">
                <h3>${s.taskName}</h3>
                <p><strong>Area:</strong> ${s.area}</p>
                <p><strong>Date:</strong> ${new Date(s.date).toLocaleDateString()}</p>
                <p><strong>Status:</strong> ${s.status}</p>
                <p><strong>Next:</strong> ${s.nextDate ? new Date(s.nextDate).toLocaleDateString() : "N/A"}</p>
            </div>
        `;
    });

    document.getElementById("content").innerHTML = content;
}

// ================= View All Complaints =================
async function viewAllComplaints() {
    const token = localStorage.getItem("token");

    const res = await fetch("http://localhost:5000/api/complaints", {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();

    let content = "<h2>All Complaints</h2>";

    data.complaints.forEach(c => {
        const statusClass = c.status.replace(" ", "");

        content += `
            <div class="card">
                <h3>${c.title}</h3>
                <p><strong>Area:</strong> ${c.area}</p>
                <p><strong>Posted by:</strong> ${c.createdBy?.name || "User"}</p>
                <p><strong>Submitted:</strong> ${new Date(c.createdAt).toLocaleString()}</p>
                <p>${c.description}</p>

                <p><strong>Status:</strong> 
                    <span class="status ${statusClass}">${c.status}</span>
                </p>

                <p><strong>Admin Response:</strong> ${c.response || "No response yet"}</p>

                <div class="vote" onclick="voteComplaint('${c._id}')">
                    ðŸ”¼ ${c.votes} Votes
                </div>
            </div>
        `;
    });

    document.getElementById("content").innerHTML = content;
}
// ================= Register Complaint =================
function registerComplaint() {
    document.getElementById("content").innerHTML = `
        <h2>Register Complaint</h2>

        <input type="text" id="title" placeholder="Title" required>
        <textarea id="description" placeholder="Describe the issue" required></textarea>
        <input type="text" id="area" placeholder="Area (Hostel A etc)" required>

        <button class="action" onclick="submitComplaint()">Submit</button>
        <p id="msg"></p>
    `;
}

async function submitComplaint() {
    const token = localStorage.getItem("token");

    const title = document.getElementById("title").value;
    const description = document.getElementById("description").value;
    const area = document.getElementById("area").value;

    const res = await fetch("http://localhost:5000/api/complaints", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ title, description, area })
    });

    const data = await res.json();
    document.getElementById("msg").innerText = data.message;
}

// ================= View My Complaints =================
async function viewMyComplaints() {
    const token = localStorage.getItem("token");
        // mark notifications as read
    await fetch("http://localhost:5000/api/complaints/notifications/mark-read", {
        method: "PUT",
        headers: { "Authorization": "Bearer " + token }
    });

    loadNotifications();

    const res = await fetch("http://localhost:5000/api/complaints/my", {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();

    let content = "<h2>My Complaints</h2>";

    data.complaints.forEach(c => {
    const statusClass = c.status.replace(" ", "");

    content += `
        <div class="card">
            <h3>${c.title}</h3>
            <p><strong>Area:</strong> ${c.area}</p>
            <p><strong>Submitted:</strong> ${new Date(c.createdAt).toLocaleString()}</p>
            <p>${c.description}</p>

            <p><strong>Status:</strong> 
                <span class="status ${statusClass}">${c.status}</span>
            </p>

            <p><strong>Admin Response:</strong> ${c.response || "No response yet"}</p>

            <div class="vote" onclick="voteComplaint('${c._id}')">
                ðŸ”¼ ${c.votes} Votes
            </div>

            ${
                c.status === "Resolved"
                ? `
                <button onclick="deleteComplaint('${c._id}')"
                    style="margin-top:10px;background:#dc2626;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">
                    Delete Complaint
                </button>
                `
                : ""
            }
        </div>
    `;
});

    document.getElementById("content").innerHTML = content;
}

// ================= Vote =================
async function voteComplaint(id) {
    const token = localStorage.getItem("token");

    const res = await fetch(`http://localhost:5000/api/complaints/${id}/vote`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    alert(data.message);
    viewMyComplaints();
}
// ================= Load Notifications =================
async function loadNotifications() {
    const token = localStorage.getItem("token");

    const res = await fetch("http://localhost:5000/api/complaints/notifications/count", {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    const badge = document.getElementById("notifBadge");

    if (data.count > 0) {
        badge.innerText = `ðŸ”” ${data.count} Update${data.count > 1 ? "s" : ""}`;
        badge.style.display = "inline-block";
    } else {
        badge.style.display = "none";
    }
}

// ================= Logout =================
function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("role");
    window.location.href = "login.html";
}
// ================= Delete Complaint =================
async function deleteComplaint(id) {
    const token = localStorage.getItem("token");

    if (!confirm("Are you sure you want to delete this complaint?")) return;

    const res = await fetch(`http://localhost:5000/api/complaints/${id}`, {
        method: "DELETE",
        headers: { 
            "Authorization": "Bearer " + token 
        }
    });

    const data = await res.json();
    alert(data.message);

    viewMyComplaints(); // refresh list
}
loadNotifications();

</script>

</body>
</html>